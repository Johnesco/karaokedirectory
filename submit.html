<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit a Venue - Austin Karaoke Directory</title>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Application styles -->
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/views.css">
    <link rel="stylesheet" href="css/submit.css">
</head>
<body>
    <header class="site-header">
        <div class="site-header__content">
            <h1 class="site-header__title">Greater Austin Karaoke Directory</h1>
            <p class="site-header__tagline">Submit a New Venue</p>
        </div>
    </header>

    <nav class="navigation-container">
        <div class="navigation">
            <a href="index.html" class="nav-btn">
                <i class="fa-solid fa-arrow-left"></i>
                <span>Back to Directory</span>
            </a>
        </div>
    </nav>

    <main class="main-content">
        <div class="submit-form">
            <div class="submit-wrapper">
            <div class="intro-text">
                <p><strong>Help us keep the directory accurate!</strong></p>
                <p>Submit a new venue or report an issue with an existing listing.</p>
            </div>

            <!-- Submission Type Tabs -->
            <div class="submission-tabs">
                <button type="button" class="submission-tab active" onclick="switchMode('new')" id="tab-new">
                    <i class="fa-solid fa-plus"></i> New Venue
                </button>
                <button type="button" class="submission-tab" onclick="switchMode('report')" id="tab-report">
                    <i class="fa-solid fa-flag"></i> Report Issue
                </button>
            </div>

            <div id="rate-limit-message" class="rate-limit-warning" style="display: none;"></div>
            <div id="success-message" class="success-message" style="display: none;"></div>

            <!-- Report Issue Form -->
            <div id="report-mode" class="form-mode">
                <form id="report-form">
                    <fieldset class="form-section">
                        <legend><i class="fa-solid fa-location-dot"></i> Which Venue?</legend>
                        <div class="form-row">
                            <div class="form-group form-group--full">
                                <label for="report-venue-name">Venue Name <span class="required">*</span></label>
                                <input type="text" id="report-venue-name" name="report-venue-name" required placeholder="Enter the venue name">
                            </div>
                        </div>
                    </fieldset>

                    <fieldset class="form-section">
                        <legend><i class="fa-solid fa-triangle-exclamation"></i> What's the Issue?</legend>
                        <div class="form-row">
                            <div class="form-group form-group--full">
                                <label>Select all that apply <span class="required">*</span></label>
                                <div id="report-issue-error" class="validation-error" style="display: none;">
                                    Please select at least one issue
                                </div>
                            </div>
                        </div>

                        <div class="quick-report-options">
                            <label class="quick-report-option">
                                <input type="checkbox" name="issue-closed" value="closed">
                                <i class="fa-solid fa-store-slash"></i>
                                <span>Venue closed / No longer exists</span>
                            </label>
                            <label class="quick-report-option">
                                <input type="checkbox" name="issue-address" value="address">
                                <i class="fa-solid fa-map-marker-alt"></i>
                                <span>Wrong address or location</span>
                            </label>
                            <label class="quick-report-option">
                                <input type="checkbox" name="issue-hours" value="hours">
                                <i class="fa-solid fa-clock"></i>
                                <span>Wrong hours or schedule</span>
                            </label>
                            <label class="quick-report-option">
                                <input type="checkbox" name="issue-cancelled" value="cancelled">
                                <i class="fa-solid fa-calendar-xmark"></i>
                                <span>Event cancelled / No longer happening</span>
                            </label>
                            <label class="quick-report-option">
                                <input type="checkbox" name="issue-kj" value="kj">
                                <i class="fa-solid fa-microphone"></i>
                                <span>KJ / Host changed</span>
                            </label>
                            <label class="quick-report-option">
                                <input type="checkbox" name="issue-other" value="other">
                                <i class="fa-solid fa-circle-info"></i>
                                <span>Other issue</span>
                            </label>
                        </div>
                    </fieldset>

                    <fieldset class="form-section">
                        <legend><i class="fa-solid fa-comment"></i> Additional Details</legend>
                        <div class="form-row">
                            <div class="form-group form-group--full">
                                <label for="report-details">Tell us more (optional)</label>
                                <textarea id="report-details" name="report-details" placeholder="Any additional information that would help us update the listing..."></textarea>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group form-group--full">
                                <label for="report-contact">Your email (optional)</label>
                                <input type="email" id="report-contact" name="report-contact" placeholder="In case we need to follow up">
                            </div>
                        </div>
                    </fieldset>

                    <div class="form-actions">
                        <button type="submit" class="btn btn--primary btn--large" id="report-submit-btn">
                            <i class="fa-solid fa-paper-plane"></i> Submit Report
                        </button>
                    </div>
                </form>
            </div>

            <!-- New Venue Form -->
            <div id="new-mode" class="form-mode active">
            <form id="venue-form">
                <!-- Honeypot field to catch bots -->
                <div class="hp-field" aria-hidden="true">
                    <label for="website_url">Leave this empty</label>
                    <input type="text" id="website_url" name="website_url" tabindex="-1" autocomplete="off">
                </div>

                <fieldset class="form-section">
                    <legend><i class="fa-solid fa-music"></i> Venue Information</legend>
                    <div class="form-row">
                        <div class="form-group form-group--full">
                            <label for="venue-name">Venue Name <span class="required">*</span></label>
                            <input type="text" id="venue-name" name="venue-name" required placeholder="e.g., The Karaoke Bar">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="dedicated">
                                <input type="checkbox" id="dedicated" name="dedicated">
                                Dedicated Karaoke Venue
                            </label>
                            <small>Check if this is primarily a karaoke venue</small>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="form-section">
                    <legend><i class="fa-solid fa-location-dot"></i> Address</legend>
                    <div class="form-row">
                        <div class="form-group form-group--full">
                            <label for="street">Street Address <span class="required">*</span></label>
                            <input type="text" id="street" name="street" required placeholder="e.g., 123 Main Street">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City <span class="required">*</span></label>
                            <input type="text" id="city" name="city" required value="Austin" placeholder="Austin">
                        </div>
                        <div class="form-group">
                            <label for="state">State</label>
                            <input type="text" id="state" name="state" value="TX" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label for="zip">ZIP Code</label>
                            <input type="text" id="zip" name="zip" pattern="\d{5}(-\d{4})?" placeholder="78701">
                        </div>
                    </div>
                </fieldset>

                <fieldset class="form-section">
                    <legend><i class="fa-solid fa-calendar"></i> Karaoke Schedule</legend>
                    <div id="schedule-entries">
                        <div class="schedule-entry" data-index="0">
                            <div class="form-group">
                                <label>Frequency</label>
                                <select name="frequency-0">
                                    <option value="every">Every</option>
                                    <option value="first">First</option>
                                    <option value="second">Second</option>
                                    <option value="third">Third</option>
                                    <option value="fourth">Fourth</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Day <span class="required">*</span></label>
                                <select name="day-0" required>
                                    <option value="">Select day...</option>
                                    <option value="sunday">Sunday</option>
                                    <option value="monday">Monday</option>
                                    <option value="tuesday">Tuesday</option>
                                    <option value="wednesday">Wednesday</option>
                                    <option value="thursday">Thursday</option>
                                    <option value="friday">Friday</option>
                                    <option value="saturday">Saturday</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Start Time</label>
                                <input type="time" name="startTime-0" value="21:00">
                            </div>
                            <div class="form-group">
                                <label>End Time</label>
                                <input type="time" name="endTime-0" value="01:00">
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn--secondary add-schedule-btn" onclick="addScheduleEntry()">
                        <i class="fa-solid fa-plus"></i> Add Another Day
                    </button>
                </fieldset>

                <fieldset class="form-section">
                    <legend><i class="fa-solid fa-microphone"></i> Host/KJ Info (Optional)</legend>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="host-name">Host Name</label>
                            <input type="text" id="host-name" name="host-name" placeholder="e.g., DJ Mike">
                        </div>
                        <div class="form-group">
                            <label for="company">Company</label>
                            <input type="text" id="company" name="company" placeholder="e.g., Karaoke Kings">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group form-group--full">
                            <label for="host-website">Host/Company Website</label>
                            <input type="url" id="host-website" name="host-website" placeholder="https://">
                        </div>
                    </div>
                </fieldset>

                <fieldset class="form-section">
                    <legend><i class="fa-solid fa-share-nodes"></i> Venue Social Links (Optional)</legend>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="venue-website"><i class="fa-solid fa-globe"></i> Website</label>
                            <input type="url" id="venue-website" name="venue-website" placeholder="https://">
                        </div>
                        <div class="form-group">
                            <label for="venue-facebook"><i class="fa-brands fa-facebook"></i> Facebook</label>
                            <input type="url" id="venue-facebook" name="venue-facebook" placeholder="https://facebook.com/...">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="venue-instagram"><i class="fa-brands fa-instagram"></i> Instagram</label>
                            <input type="url" id="venue-instagram" name="venue-instagram" placeholder="https://instagram.com/...">
                        </div>
                        <div class="form-group">
                            <label for="venue-twitter"><i class="fa-brands fa-x-twitter"></i> X/Twitter</label>
                            <input type="url" id="venue-twitter" name="venue-twitter" placeholder="https://x.com/...">
                        </div>
                    </div>
                </fieldset>

                <fieldset class="form-section">
                    <legend><i class="fa-solid fa-comment"></i> Additional Notes</legend>
                    <div class="form-row">
                        <div class="form-group form-group--full">
                            <label for="notes">Anything else we should know?</label>
                            <textarea id="notes" name="notes" placeholder="e.g., Private rooms available, cover charge, special events, etc."></textarea>
                        </div>
                    </div>
                </fieldset>

                <fieldset class="form-section">
                    <legend><i class="fa-solid fa-user"></i> About You</legend>
                    <div class="form-row">
                        <div class="form-group form-group--full">
                            <label>Are you the KJ/Host for this venue?</label>
                            <div class="radio-group">
                                <label class="radio-option">
                                    <input type="radio" name="submitter-type" value="fan" checked onchange="toggleSubmitterType()">
                                    <span>Just a fan / patron</span>
                                </label>
                                <label class="radio-option">
                                    <input type="radio" name="submitter-type" value="kj" onchange="toggleSubmitterType()">
                                    <span>I'm the KJ / Host</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-row" style="margin-top: var(--spacing-md);">
                        <div class="form-group form-group--full">
                            <label for="submitter-name">Your Name <span id="name-required" class="required" style="display: none;">*</span></label>
                            <input type="text" id="submitter-name" name="submitter-name" placeholder="So we can credit you!">
                            <div id="name-error" class="validation-error" style="display: none;">
                                Name is required for KJs/Hosts
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group form-group--full">
                            <label>How would you like to be contacted? <span id="contact-required" class="required" style="display: none;">*</span></label>
                            <small id="contact-hint">Optional - provide if you'd like us to reach out</small>
                            <div id="contact-error" class="validation-error" style="display: none;">
                                Please provide at least one contact method
                            </div>
                        </div>
                    </div>

                    <div class="checkbox-group">
                        <div>
                            <label class="checkbox-option">
                                <input type="checkbox" name="contact-email-check" onchange="toggleContactInput('email')">
                                <span><i class="fa-solid fa-envelope"></i> Email</span>
                            </label>
                            <div id="contact-email-input" class="contact-input hidden">
                                <input type="email" name="contact-email" placeholder="your@email.com">
                            </div>
                        </div>

                        <div>
                            <label class="checkbox-option">
                                <input type="checkbox" name="contact-text-check" onchange="toggleContactInput('text')">
                                <span><i class="fa-solid fa-message"></i> Phone (Text)</span>
                            </label>
                            <div id="contact-text-input" class="contact-input hidden">
                                <input type="tel" name="contact-text" placeholder="(512) 555-1234">
                            </div>
                        </div>

                        <div>
                            <label class="checkbox-option">
                                <input type="checkbox" name="contact-call-check" onchange="toggleContactInput('call')">
                                <span><i class="fa-solid fa-phone"></i> Phone (Call)</span>
                            </label>
                            <div id="contact-call-input" class="contact-input hidden">
                                <input type="tel" name="contact-call" placeholder="(512) 555-1234">
                            </div>
                        </div>

                        <div>
                            <label class="checkbox-option">
                                <input type="checkbox" name="contact-other-check" onchange="toggleContactInput('other')">
                                <span><i class="fa-solid fa-ellipsis"></i> Other</span>
                            </label>
                            <div id="contact-other-input" class="contact-input hidden">
                                <textarea name="contact-other" placeholder="e.g., Instagram DM @handle, Facebook, etc." rows="2"></textarea>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <div class="form-actions">
                    <button type="submit" class="btn btn--primary btn--large" id="submit-btn">
                        <i class="fa-solid fa-paper-plane"></i> Generate Email
                    </button>
                    <button type="button" class="btn btn--secondary btn--large" onclick="previewJSON()">
                        <i class="fa-solid fa-eye"></i> Preview JSON
                    </button>
                </div>
            </form>
            </div><!-- end new-mode -->
            </div><!-- end submit-wrapper -->

            <!-- JSON Preview Modal -->
            <div id="json-preview-modal" class="venue-modal">
                <div class="venue-modal__backdrop" onclick="closePreview()"></div>
                <div class="venue-modal__content">
                    <button class="venue-modal__close" onclick="closePreview()">
                        <i class="fa-solid fa-times"></i>
                    </button>
                    <h3 style="margin-bottom: var(--spacing-md);">JSON Preview</h3>
                    <pre id="json-preview" style="background: var(--bg-secondary); padding: var(--spacing-md); border-radius: var(--border-radius-sm); overflow-x: auto; font-size: var(--font-size-sm);"></pre>
                    <div style="margin-top: var(--spacing-md); display: flex; gap: var(--spacing-sm);">
                        <button class="btn btn--primary" onclick="copyJSON()">
                            <i class="fa-solid fa-copy"></i> Copy JSON
                        </button>
                        <button class="btn btn--secondary" onclick="closePreview()">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer class="site-footer">
        <div class="site-footer__social">
            <h2>Follow Us</h2>
            <div class="social-links">
                <a href="https://www.facebook.com/groups/2494105004273043"
                   target="_blank" rel="noopener noreferrer" title="Facebook">
                    <i class="fa-brands fa-facebook fa-lg"></i>
                </a>
                <a href="https://www.instagram.com/karaokedirectory/"
                   target="_blank" rel="noopener noreferrer" title="Instagram">
                    <i class="fa-brands fa-instagram fa-lg"></i>
                </a>
            </div>
        </div>
        <div class="site-footer__links">
            <a href="about.html">About Us</a>
            <a href="submit.html">Submit Venue</a>
        </div>
        <p class="site-footer__copyright">
            &copy; 2025 Austin Karaoke Directory
        </p>
    </footer>

    <script>
        // Rate limiting configuration
        const RATE_LIMIT_CONFIG = {
            maxSubmissions: 3,      // Max submissions allowed
            windowMs: 60 * 60 * 1000, // Time window: 1 hour in milliseconds
            storageKey: 'karaoke-submit-history'
        };

        // Email configuration
        const EMAIL_ADDRESS = 'karaokedirectoryatx@gmail.com'; // Change this to your email

        let scheduleCount = 1;

        // Switch between New Venue and Report Issue modes
        function switchMode(mode) {
            const newMode = document.getElementById('new-mode');
            const reportMode = document.getElementById('report-mode');
            const tabNew = document.getElementById('tab-new');
            const tabReport = document.getElementById('tab-report');

            if (mode === 'new') {
                newMode.classList.add('active');
                reportMode.classList.remove('active');
                tabNew.classList.add('active');
                tabReport.classList.remove('active');
            } else {
                newMode.classList.remove('active');
                reportMode.classList.add('active');
                tabNew.classList.remove('active');
                tabReport.classList.add('active');
            }

            // Clear any displayed messages
            document.getElementById('success-message').style.display = 'none';
        }

        // Toggle submitter type - show/hide required indicators
        function toggleSubmitterType() {
            const isKJ = document.querySelector('input[name="submitter-type"]:checked')?.value === 'kj';

            // Toggle required indicators
            document.getElementById('name-required').style.display = isKJ ? 'inline' : 'none';
            document.getElementById('contact-required').style.display = isKJ ? 'inline' : 'none';

            // Update hint text
            const hint = document.getElementById('contact-hint');
            hint.textContent = isKJ
                ? 'Required - please provide at least one contact method'
                : 'Optional - provide if you\'d like us to reach out';

            // Clear errors when switching
            document.getElementById('name-error').style.display = 'none';
            document.getElementById('contact-error').style.display = 'none';
        }

        // Toggle individual contact input visibility
        function toggleContactInput(type) {
            const checkbox = document.querySelector(`input[name="contact-${type}-check"]`);
            const inputDiv = document.getElementById(`contact-${type}-input`);

            if (checkbox.checked) {
                inputDiv.classList.remove('hidden');
                inputDiv.querySelector('input, textarea')?.focus();
            } else {
                inputDiv.classList.add('hidden');
                // Clear the input when unchecking
                const input = inputDiv.querySelector('input, textarea');
                if (input) input.value = '';
            }

            // Clear contact error when any checkbox is checked
            document.getElementById('contact-error').style.display = 'none';
        }

        // Validate submitter info (name required for KJ, contact required for KJ)
        function validateSubmitterInfo() {
            const isKJ = document.querySelector('input[name="submitter-type"]:checked')?.value === 'kj';

            if (!isKJ) return true; // No validation needed for fans

            let isValid = true;

            // Validate name for KJ
            const name = document.getElementById('submitter-name').value.trim();
            if (!name) {
                document.getElementById('name-error').style.display = 'block';
                document.getElementById('submitter-name').scrollIntoView({ behavior: 'smooth', block: 'center' });
                isValid = false;
            } else {
                document.getElementById('name-error').style.display = 'none';
            }

            // Validate contact for KJ
            const emailCheck = document.querySelector('input[name="contact-email-check"]').checked;
            const textCheck = document.querySelector('input[name="contact-text-check"]').checked;
            const callCheck = document.querySelector('input[name="contact-call-check"]').checked;
            const otherCheck = document.querySelector('input[name="contact-other-check"]').checked;

            const email = document.querySelector('input[name="contact-email"]').value.trim();
            const text = document.querySelector('input[name="contact-text"]').value.trim();
            const call = document.querySelector('input[name="contact-call"]').value.trim();
            const other = document.querySelector('textarea[name="contact-other"]').value.trim();

            // Check if at least one contact method is provided with a value
            const hasValidContact =
                (emailCheck && email) ||
                (textCheck && text) ||
                (callCheck && call) ||
                (otherCheck && other);

            if (!hasValidContact) {
                document.getElementById('contact-error').style.display = 'block';
                if (isValid) { // Only scroll if name was valid (so we don't override name scroll)
                    document.getElementById('contact-error').scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                isValid = false;
            } else {
                document.getElementById('contact-error').style.display = 'none';
            }

            return isValid;
        }

        // Check rate limit on page load
        document.addEventListener('DOMContentLoaded', function() {
            checkRateLimit();
        });

        function getSubmissionHistory() {
            try {
                const history = localStorage.getItem(RATE_LIMIT_CONFIG.storageKey);
                return history ? JSON.parse(history) : [];
            } catch (e) {
                return [];
            }
        }

        function saveSubmission() {
            const history = getSubmissionHistory();
            history.push(Date.now());
            localStorage.setItem(RATE_LIMIT_CONFIG.storageKey, JSON.stringify(history));
        }

        function checkRateLimit() {
            const history = getSubmissionHistory();
            const now = Date.now();
            const windowStart = now - RATE_LIMIT_CONFIG.windowMs;

            // Filter to only submissions within the time window
            const recentSubmissions = history.filter(timestamp => timestamp > windowStart);

            // Clean up old entries
            localStorage.setItem(RATE_LIMIT_CONFIG.storageKey, JSON.stringify(recentSubmissions));

            const messageEl = document.getElementById('rate-limit-message');
            const submitBtn = document.getElementById('submit-btn');

            if (recentSubmissions.length >= RATE_LIMIT_CONFIG.maxSubmissions) {
                const oldestRecent = Math.min(...recentSubmissions);
                const resetTime = new Date(oldestRecent + RATE_LIMIT_CONFIG.windowMs);
                const minutesRemaining = Math.ceil((resetTime - now) / (60 * 1000));

                messageEl.textContent = `You've reached the submission limit (${RATE_LIMIT_CONFIG.maxSubmissions} per hour). Please try again in ${minutesRemaining} minute${minutesRemaining !== 1 ? 's' : ''}.`;
                messageEl.classList.add('error');
                messageEl.style.display = 'block';
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.5';
                submitBtn.style.cursor = 'not-allowed';
                return false;
            } else if (recentSubmissions.length >= RATE_LIMIT_CONFIG.maxSubmissions - 1) {
                messageEl.textContent = `You have 1 submission remaining this hour.`;
                messageEl.classList.remove('error');
                messageEl.style.display = 'block';
            } else {
                messageEl.style.display = 'none';
            }

            submitBtn.disabled = false;
            submitBtn.style.opacity = '1';
            submitBtn.style.cursor = 'pointer';
            return true;
        }

        function addScheduleEntry() {
            const container = document.getElementById('schedule-entries');
            const entry = document.createElement('div');
            entry.className = 'schedule-entry';
            entry.dataset.index = scheduleCount;

            entry.innerHTML = `
                <div class="form-group">
                    <label>Frequency</label>
                    <select name="frequency-${scheduleCount}">
                        <option value="every">Every</option>
                        <option value="first">First</option>
                        <option value="second">Second</option>
                        <option value="third">Third</option>
                        <option value="fourth">Fourth</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Day</label>
                    <select name="day-${scheduleCount}">
                        <option value="">Select day...</option>
                        <option value="sunday">Sunday</option>
                        <option value="monday">Monday</option>
                        <option value="tuesday">Tuesday</option>
                        <option value="wednesday">Wednesday</option>
                        <option value="thursday">Thursday</option>
                        <option value="friday">Friday</option>
                        <option value="saturday">Saturday</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Start Time</label>
                    <input type="time" name="startTime-${scheduleCount}" value="21:00">
                </div>
                <div class="form-group">
                    <label>End Time</label>
                    <input type="time" name="endTime-${scheduleCount}" value="01:00">
                </div>
                <button type="button" class="remove-schedule-btn" onclick="removeScheduleEntry(this)">
                    <i class="fa-solid fa-trash"></i> Remove
                </button>
            `;

            container.appendChild(entry);
            scheduleCount++;
        }

        function removeScheduleEntry(btn) {
            btn.closest('.schedule-entry').remove();
        }

        function generateVenueId(name) {
            return name.toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();
        }

        function collectFormData() {
            const form = document.getElementById('venue-form');
            const formData = new FormData(form);

            // Check honeypot
            if (formData.get('website_url')) {
                return null; // Bot detected
            }

            const venueName = formData.get('venue-name')?.trim();
            if (!venueName) return null;

            // Collect schedule entries
            const scheduleEntries = document.querySelectorAll('.schedule-entry');
            const schedule = [];

            scheduleEntries.forEach((entry) => {
                const index = entry.dataset.index;
                const frequency = formData.get(`frequency-${index}`);
                const day = formData.get(`day-${index}`);
                const startTime = formData.get(`startTime-${index}`) || '21:00';
                const endTime = formData.get(`endTime-${index}`) || '01:00';

                if (day) {
                    schedule.push({
                        frequency: frequency,
                        day: day,
                        startTime: startTime,
                        endTime: endTime
                    });
                }
            });

            // Build venue object in standard format
            const venue = {
                id: generateVenueId(venueName),
                name: venueName,
                dedicated: formData.get('dedicated') ? true : false,
                address: {
                    street: formData.get('street')?.trim() || '',
                    city: formData.get('city')?.trim() || 'Austin',
                    state: formData.get('state')?.trim() || 'TX',
                    zip: formData.get('zip')?.trim() || ''
                },
                schedule: schedule
            };

            // Optional: Host info
            const hostName = formData.get('host-name')?.trim();
            const company = formData.get('company')?.trim();
            const hostWebsite = formData.get('host-website')?.trim();

            if (hostName || company || hostWebsite) {
                venue.host = {};
                if (hostName) venue.host.name = hostName;
                if (company) venue.host.company = company;
                if (hostWebsite) venue.host.website = hostWebsite;
            }

            // Optional: Venue socials
            const venueWebsite = formData.get('venue-website')?.trim();
            const venueFacebook = formData.get('venue-facebook')?.trim();
            const venueInstagram = formData.get('venue-instagram')?.trim();
            const venueTwitter = formData.get('venue-twitter')?.trim();

            if (venueWebsite || venueFacebook || venueInstagram || venueTwitter) {
                venue.socials = {};
                if (venueWebsite) venue.socials.website = venueWebsite;
                if (venueFacebook) venue.socials.facebook = venueFacebook;
                if (venueInstagram) venue.socials.instagram = venueInstagram;
                if (venueTwitter) venue.socials.twitter = venueTwitter;
            }

            // Collect metadata
            const notes = formData.get('notes')?.trim();
            const submitterName = formData.get('submitter-name')?.trim();
            const submitterType = formData.get('submitter-type');

            // Collect contact info (for both fans and KJs)
            const contactMethods = [];
            if (formData.get('contact-email-check')) {
                const email = formData.get('contact-email')?.trim();
                if (email) contactMethods.push({ type: 'email', value: email });
            }
            if (formData.get('contact-text-check')) {
                const text = formData.get('contact-text')?.trim();
                if (text) contactMethods.push({ type: 'text', value: text });
            }
            if (formData.get('contact-call-check')) {
                const call = formData.get('contact-call')?.trim();
                if (call) contactMethods.push({ type: 'call', value: call });
            }
            if (formData.get('contact-other-check')) {
                const other = formData.get('contact-other')?.trim();
                if (other) contactMethods.push({ type: 'other', value: other });
            }

            return {
                venue,
                notes,
                submitterName,
                submitterType,
                contactMethods
            };
        }

        function formatEmailBody(data) {
            if (!data) return null;

            const isKJ = data.submitterType === 'kj';

            let body = 'NEW VENUE SUBMISSION\n';
            body += '='.repeat(40) + '\n\n';

            // Submitter info
            body += 'SUBMITTED BY:\n';
            if (data.submitterName) {
                body += `Name: ${data.submitterName}\n`;
            }
            body += `Type: ${isKJ ? 'KJ / Host' : 'Fan / Patron'}\n`;

            // Contact info (for both fans and KJs)
            if (data.contactMethods && data.contactMethods.length > 0) {
                body += `\n${isKJ ? 'KJ ' : ''}CONTACT PREFERENCES:\n`;
                data.contactMethods.forEach(method => {
                    const labels = {
                        email: 'Email',
                        text: 'Phone (Text)',
                        call: 'Phone (Call)',
                        other: 'Other'
                    };
                    body += `- ${labels[method.type]}: ${method.value}\n`;
                });
            }
            body += '\n';

            body += 'VENUE JSON (copy/paste ready):\n';
            body += '-'.repeat(40) + '\n';
            body += JSON.stringify(data.venue, null, 2);
            body += '\n' + '-'.repeat(40) + '\n\n';

            if (data.notes) {
                body += 'ADDITIONAL NOTES:\n';
                body += data.notes + '\n\n';
            }

            body += 'TODO:\n';
            body += '- [ ] Verify venue information\n';
            body += '- [ ] Add coordinates (lat/lng)\n';
            body += '- [ ] Add to data.js\n';
            if (isKJ) {
                body += '- [ ] Contact KJ to confirm details\n';
            }

            return body;
        }

        function previewJSON() {
            const data = collectFormData();

            if (!data) {
                alert('Please fill in at least the venue name.');
                return;
            }

            const preview = document.getElementById('json-preview');
            preview.textContent = JSON.stringify(data.venue, null, 2);

            const modal = document.getElementById('json-preview-modal');
            modal.classList.add('venue-modal--open');
        }

        function closePreview() {
            const modal = document.getElementById('json-preview-modal');
            modal.classList.remove('venue-modal--open');
        }

        function copyJSON() {
            const data = collectFormData();
            if (data) {
                navigator.clipboard.writeText(JSON.stringify(data.venue, null, 2))
                    .then(() => alert('JSON copied to clipboard!'))
                    .catch(() => alert('Failed to copy. Please select and copy manually.'));
            }
        }

        // Toggle visual feedback for quick report options
        document.querySelectorAll('.quick-report-option input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const option = this.closest('.quick-report-option');
                if (this.checked) {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
                // Clear validation error when any checkbox is selected
                document.getElementById('report-issue-error').style.display = 'none';
            });
        });

        // Validate report form - at least one issue must be selected
        function validateReportForm() {
            const checkboxes = document.querySelectorAll('.quick-report-options input[type="checkbox"]');
            const hasSelection = Array.from(checkboxes).some(cb => cb.checked);

            if (!hasSelection) {
                document.getElementById('report-issue-error').style.display = 'block';
                document.getElementById('report-issue-error').scrollIntoView({ behavior: 'smooth', block: 'center' });
                return false;
            }

            const venueName = document.getElementById('report-venue-name').value.trim();
            if (!venueName) {
                document.getElementById('report-venue-name').focus();
                return false;
            }

            return true;
        }

        // Collect report form data
        function collectReportData() {
            const venueName = document.getElementById('report-venue-name').value.trim();
            const details = document.getElementById('report-details').value.trim();
            const contact = document.getElementById('report-contact').value.trim();

            const issues = [];
            const issueLabels = {
                'issue-closed': 'Venue closed / No longer exists',
                'issue-address': 'Wrong address or location',
                'issue-hours': 'Wrong hours or schedule',
                'issue-cancelled': 'Event cancelled / No longer happening',
                'issue-kj': 'KJ / Host changed',
                'issue-other': 'Other issue'
            };

            document.querySelectorAll('.quick-report-options input[type="checkbox"]:checked').forEach(cb => {
                issues.push(issueLabels[cb.name] || cb.value);
            });

            return {
                venueName,
                issues,
                details,
                contact
            };
        }

        // Format report email body
        function formatReportEmailBody(data) {
            let body = 'VENUE ISSUE REPORT\n';
            body += '='.repeat(40) + '\n\n';

            body += `VENUE: ${data.venueName}\n\n`;

            body += 'REPORTED ISSUES:\n';
            data.issues.forEach(issue => {
                body += `- ${issue}\n`;
            });
            body += '\n';

            if (data.details) {
                body += 'ADDITIONAL DETAILS:\n';
                body += data.details + '\n\n';
            }

            if (data.contact) {
                body += 'REPORTER CONTACT:\n';
                body += data.contact + '\n\n';
            }

            body += 'TODO:\n';
            body += '- [ ] Verify reported issues\n';
            body += '- [ ] Update venue listing\n';

            return body;
        }

        // Report form submission
        document.getElementById('report-form').addEventListener('submit', function(e) {
            e.preventDefault();

            // Validate
            if (!validateReportForm()) {
                return;
            }

            // Check rate limit
            if (!checkRateLimit()) {
                return;
            }

            const data = collectReportData();
            const emailBody = formatReportEmailBody(data);
            const subject = `Issue Report: ${data.venueName}`;

            // Create mailto link
            const mailtoLink = `mailto:${EMAIL_ADDRESS}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;

            // Record submission for rate limiting
            saveSubmission();

            // Open email client
            window.location.href = mailtoLink;

            // Show success message
            const successEl = document.getElementById('success-message');
            successEl.innerHTML = `
                <i class="fa-solid fa-check-circle"></i>
                <strong>Report prepared!</strong><br>
                Your email client should open with the issue report. If it doesn't,
                <a href="${mailtoLink}" style="color: white; text-decoration: underline;">click here</a>.
            `;
            successEl.style.display = 'block';

            // Update rate limit display
            checkRateLimit();

            // Scroll to top to show message
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Form submission
        document.getElementById('venue-form').addEventListener('submit', function(e) {
            e.preventDefault();

            // Check rate limit
            if (!checkRateLimit()) {
                return;
            }

            // Validate submitter info (name and contact required for KJs)
            if (!validateSubmitterInfo()) {
                return;
            }

            const data = collectFormData();

            if (!data) {
                // Could be bot or empty form
                alert('Please fill in the required fields.');
                return;
            }

            const emailBody = formatEmailBody(data);
            const subject = `New Venue Submission: ${data.venue.name}`;

            // Create mailto link
            const mailtoLink = `mailto:${EMAIL_ADDRESS}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBody)}`;

            // Record submission for rate limiting
            saveSubmission();

            // Open email client
            window.location.href = mailtoLink;

            // Show success message
            const successEl = document.getElementById('success-message');
            successEl.innerHTML = `
                <i class="fa-solid fa-check-circle"></i>
                <strong>Email prepared!</strong><br>
                Your email client should open with the venue details. If it doesn't,
                <a href="${mailtoLink}" style="color: white; text-decoration: underline;">click here</a>.
            `;
            successEl.style.display = 'block';

            // Update rate limit display
            checkRateLimit();

            // Scroll to top to show message
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    </script>
</body>
</html>
